{"title":"Case study 1: Rana Pretiosa","markdown":{"headingText":"Case study 1: Rana Pretiosa","containsRefs":false,"markdown":"\n\nThe first case study is about animal ecology, we will be looking at a frog particular specie **Rana Pretiosa**, scientific name **Rana pretiosa Baird & Girard, 1853**, and use some interesting data from Oregon as well as downloading more data from **GBIF | Global Biodiversity Information Facility**.\n\nThe scope is to visualize the presence of these nice little frogs across different location with making a map using {ggplot2} by Hadley Wickham.\n\n### Get started making a map!\n\nThe first map that we make is a general frog location map of the United States. In this case we need the {spocc} package by Hannah Owens and Vijay Barve and Scott Chamberlain, to load the data from GBIF and make the map.\n\n```{r}\n#| label: ch2\n#| eval: TRUE\n#| message: FALSE\n#| warning: FALSE\n#| paged.print: FALSE\nlibrary(tidyverse)\nlibrary(oregonfrogs)\nlibrary(spocc)\n```\n\n```{r}\nload(\"data/case_study_1.RData\")\n```\n\n```{r}\n#| label: ch2-01\n#| eval: FALSE\n#| cache: TRUE\ndo_gbif <- occ(\"Rana pretiosa Baird & Girard, 1853\",\n               from = \"gbif\",\n               limit = 1000,\n               has_coords = TRUE\n               )\n\ndo_gbif1 <- data.frame(do_gbif$gbif$data)\n```\n\n\n```{r}\n#| label: ch2-02\ndo_gbif2 <- do_gbif1%>%\n  rename(longitude=Rana_pretiosa_Baird_._Girard._1853.longitude,\n         latitude=Rana_pretiosa_Baird_._Girard._1853.latitude)\n```\n\n\n```{r}\n#| label: ch2-03\n#| message: FALSE\n#| warning: FALSE\n#| paged.print: FALSE\nstates<- map_data(\"state\")\noregon <- states %>% filter(region==\"oregon\")\n\nggplot(data = states, mapping = aes(long,lat,group=region))+\n  geom_polygon(color=\"grey\",fill=NA) +\n  geom_polygon(data = oregon, \n               inherit.aes = TRUE, \n               color=\"pink\",fill=\"pink\") +\n  geom_point(data = do_gbif2,\n             mapping = aes(x=longitude, y=latitude),\n             inherit.aes = FALSE, \n             alpha=0.5,size=0.5)+\n  coord_quickmap() +\n  theme_bw()\n```\n\n\nOnce visualized, we will be making some assumptions about their movement and habitat use based on the results of a study by Dr. Michael J Adams from the Forest and Rangeland Ecosystem Science Center in Oregon.\n\nMore information about this study can be found here: https://doi.org/10.1670/20-060\n\n\nThe dataset has been released for #TidyTuesday 2022 week 31 and can be downloaded here: https://github.com/rfordatascience/tidytuesday/tree/master/data/2022/2022-08-02\n\nOr, you can install the package from github: https://github.com/Fgazzelloni/oregonfrogs\n\n```{r}\n#| label: ch2-04\n#| echo: FALSE\n#| out.width: \"30%\"\n#| fig.align: 'center'\n#| fig.cap: \"Credits: oregonfrogs package\"\nknitr::include_graphics(\"images/oregonfrogs.png\")\n```\n\n```{r}\n#| label: ch2-05\n#| eval: FALSE\n#| message: FALSE\n#| warning: FALSE\n#| include: TRUE\n#| paged.print: FALSE\n\n# install.packages(\"remotes\")\nremotes::install_github(\"fgazzelloni/oregonfrogs\")\n```\n\n\nOne of the most important step of spatial modeling, and modeling in general, is to have a good knowledge of the argument. So, the more we know about **Rana Pretiosa** the better!\n\nLet's hear **Rana Pretiosa** sound: https://amphibiaweb.org/species/5131\n\nMore information about Rana pretiosa can be found here:\n\n- [GBIF](https://www.gbif.org/species/2426776)\n\nIn particular, we will be looking at the location where **rana pretiosa** has been located with the use of radio telemetry frequencies in the **Crane Prairie Reservoir**, which is a man-made lake located about 42 miles (68 km) southwest of Bend in Deschutes County, Oregon, United States.[^14]\n\n[^14]: [Crane Prairie Reservoir](https://en.wikipedia.org/wiki/Crane_Prairie_Reservoir)\n\nAn interesting map of the lake with related data can be found here: [Lake and Reservoir in Deschutes County in Oregon map data](https://data.deschutes.org/datasets/deschutes::lakes-and-reservoirs-1/explore)\n\n\nWe will require more packages while performing our analysis. \n\n```{r}\n#| label: ch2-06\n#| message: FALSE\n#| warning: FALSE\n#| paged.print: FALSE\nlibrary(oregonfrogs)  \n```\n\nLet's have a look at the data, we have 311 observations and 16 variables which include the habitat type, the date, the radio frequency, and other variables such as gender, type of water, presence of beavers, and if they are captured, located or just visualized.\n\nSo, many interesting hypothesis can be done about their movements habitat use.\n\n```{r}\n#| label: ch2-07\n#| comment: \"\"\noregonfrogs%>%head(3)\n```\n\n\nOne more interesting information is about the location, in this case a **UTM distance** (from the Equator or from the North) is provided, and this type of localization is the most suitable for animal location. \n\nThe **Universal Transverse Mercator (UTM)** is a common projection is  which preserves local angles and shapes, and divides the Earth into 60 zones of 6 degrees of longitude in width. Each of the zones uses a transverse Mercator projection that maps a region of large north-south extent. [^15]\n\n[^15]: [Geospatial Health Data: Modeling and Visualization with R-INLA and Shiny](https://www.paulamoraga.com/book-geospatial/sec-spatialdataandCRS.html)\n\nInteresting is that it is expressed in meters, so it gives more opportunity in case one wants to consider the distance. For now, we transform these UTM projections into **longitude** and **latitude**. For doing this we need the {sf} package by Edzer Pebesma.\n\nMany are the GIS packages available in R to use, and sometime is difficult to make a choice as they are all very useful and interesting. \n\nTo transform the UTM values into long and lat we use the `sf::st_as_sf()` function with some arguments which are compulsory for what we do.\n\nWe need to specify where the coordinates are located in our set, and set a **CRS** or coordinate reference system information. \n\n\n```{r}\n#| label: ch2-08\n#| comment: \"\"\n\n\n# Build a tibble with the geo-location information\nfrogs_coord <- oregonfrogs %>%\n  dplyr::select(UTME_83, UTMN_83)\n\n# Tranform it to lat and long\nfrogs_coord <- \n  frogs_coord %>% \n  # transform to simple features as geometry\n  sf::st_as_sf(coords = c(1,2), \n               crs = \"+proj=utm +zone=10\") %>%\n  # utm tranformation to longlat\n  sf::st_transform(crs = \"+proj=longlat +datum=WGS84\")  %>%\n  tibble()\n\nfrogs_coord%>%head(3)\n```\n\nAs you can see the first projection points to *utm* as the type of data provided and set the zone 10. While the second transformation applies to longlat types projection on WGS84, (World Geodetic System 1984, known as EPSG:4326), which express the degree of longitude and latitude starting from a particular point of view, in this case EPSG:4326.\n\n\n```{r}\n#| label: ch2-09\n#| echo: FALSE\n#| fig.dim: \"50%\"\n#| fig.align: 'center'\n#| fig.cap: \"Credits: https://epsg.io/4326\"\nknitr::include_graphics(\"images/epsg_4326.png\")\n```\n\nAll the available CRS in R can be seen by typing `View(rgdal::make_EPSG())` [^16]\n\n[^16]: [book geospatial](https://www.paulamoraga.com/book-geospatial/sec-spatialdataandCRS.html)\n\n\n```{r}\n#| label: ch2-10\n#| comment: \"\"\nlibrary(purrr)\nfrogs_location <- tibble(Detection = oregonfrogs$Detection,\n                         Subsite = oregonfrogs$Subsite,\n                         Frequency = oregonfrogs$Frequency,\n                         lat = unlist(map(frogs_coord$geometry, 2)),\n                         long = unlist(map(frogs_coord$geometry, 1)))\n\nfrogs_location%>%head(3)\n```\n\n\n## Look at oregonfrogs data\n\nLet's have a first sight at the data based on location. The first thing to notice is that points (frogs) are aligned following some sort of linearity. But, what is the difference from other data, is that now these points are following an environment. Let's have a look at it.\n\n```{r}\n#| label: ch2-11\n#| message: FALSE\n#| warning: FALSE\n#| paged.print: FALSE\nggplot(data = frogs_location, aes(x=long,y=lat))+\n  geom_point() +\n  geom_smooth(method = \"loess\") +\n  theme_bw()\n```\n\n\n### Let's map the lake! \n\nHow do we set the map for the location of our **Rana Pretiosa** in the Crane Prairie Reservoir?\n\nIn the study page we can find the **BOX**, the box is the four corner reference points, bounding our interested area. \n\nBounding Box: https://www.sciencebase.gov/catalog/item/imap/60ba5a00d34e86b9388d86bc\n\nBounding Box[-121.824775, 43.764375, -121.764923, 43.814821]\n\nThe area can be retrieved with {OpenStreetMap} package by : Ian Fellows and visualized with a nice resolution with the `plot.OpenStreetMap()` or simply the `plot()` function. The {OpenStreetMap} doesn't work the same for all systems. You'll might need to use another package, such as {ggmap} which provide the same background map to use with {ggplot2}.\n\nSo, don't run this part if you incurr issues with {OpenStreetMap}, jump on the next one.\n\n```{r}\n#| label: ch2-12\n#| eval: FALSE\nlibrary(OpenStreetMap)\nmap <- openmap(c(43.764375,-121.824775),c(43.814821,-121.764923))\n\nOpenStreetMap::plot.OpenStreetMap(map)\nwider_map <- openproj(map)\nbase_map <- OpenStreetMap::autoplot.OpenStreetMap(wider_map) + \n  geom_point(data = frogs_location,\n             aes(x = long, y = lat), \n             shape=21,stroke=0.2, size =  4,\n             color=\"grey40\") +\n  xlab(\"Longitude (°E)\") + ylab(\"Latitude (°S)\")\n```\n\n```{r}\n#| label: ch2-12-1\n#| echo: FALSE\n#| out.width: \"50%\"\n#| fig.cap: \"Crane Prairie Reservoir\"\nknitr::include_graphics(\"images/background_map.png\")\n```\n\n\nIn this map is made with {ggmap} and {ggplot2} for the frogs locations.\n\n\n```{r}\n#| label: ch2-13\n#| message: FALSE\n#| warning: FALSE\n#| paged.print: FALSE\nlibrary(ggmap)\n```\n\n```{r}\n#| label: ch2-14\n#| eval: FALSE\n#| cache: TRUE\nbox=c(43.764375,-121.824775,43.814821,-121.764923)\ncrane_reservoir <- get_stamenmap(bbox = c(left = -121.824775, \n                                          bottom = 43.764375, \n                                          right = -121.764923, \n                                          top = 43.814821),\n                                 zoom = 13, color = c(\"color\"),\n                                 maptype = \"terrain-background\")\n\n```\n\n\n\n```{r}\n#| label: ch2-15\nbase_map <- ggmap(crane_reservoir) + \n    geom_point(data = frogs_location,\n             aes(x = long, y = lat), \n             shape=21,stroke=0.2, size =  4,\n             color=\"grey40\") +\n  xlab(\"Longitude (°E)\") + ylab(\"Latitude (°S)\")\n\nbase_map\n```\n\n\n\n## Time as coordinate\n\nWith a little modification of the dataset we can visualize the frogs by months. This study has been carried from mid September 2018 to late November of the same year, so three months of observations.\n\n```{r}\n#| label: ch2-16\n#| message: FALSE\n#| warning: FALSE\n#| paged.print: FALSE\n\n\nfrogs_location_tm <- tibble(ReportedDay = oregonfrogs$Ordinal,\n                            geometry=frogs_coord$geometry) %>%\n  mutate(time = as.Date(\"2018-01-01\") + ReportedDay,\n         month=lubridate::month(time))\n```\n\n```{r}\n#| label: ch2-16-1\n#| eval: true\nbase_map +\n  geom_sf(data = frogs_location_tm,\n          aes(col = factor(month), geometry = geometry),\n          inherit.aes = F) +\n  facet_wrap(~cut(time, \"1 months\")) + \n  scale_color_discrete(labels = c(\"September\",\"October\",\"November\"))+\n  labs(color = \"Month\")+\n  theme_void()\n```\n\n\nSome speculation could be done about the reasons why the frogs are not located in some substrates of the lake in September more than in November.  \n\n## Make a grid\n\nLet's create a grid of points around the frogs' locations. In order to do that we need the {sf} package, initially we do the same as before, but now we want a **Simple feature** collection of points and not a tibble with coordinates as before. The functions `sf::st_make_grid()` and `sf::st_as_sfc(sf::st_bbox(points))` with the bbox reference for the points let us create a grid.\n\n```{r}\n#| label: ch2-17\n#| message: FALSE\n#| warning: FALSE\n#| paged.print: FALSE\n\n\n# make a grid\nfrogs_coord_freq <- tibble(oregonfrogs$UTME_83, oregonfrogs$UTMN_83,\n                      oregonfrogs$Frequency)\n\npoints <- sf::st_as_sf(x = frogs_coord_freq, \n                       coords = c(1,2), \n                       crs = \"+proj=utm +zone=10\") %>%\n  sf::st_transform(frogs_coord, \n                   crs = \"+proj=longlat +datum=WGS84\")  \n\ngrid = sf::st_make_grid(\n  sf::st_as_sfc(sf::st_bbox(points)),\n  what = \"centers\",\n  cellsize = .002, \n  square = F)\n\n\nggplot()+\n  geom_sf(data=grid,size=0.3)+\n  geom_sf(data=points)+\n  coord_sf()+\n  ggthemes::theme_map()\n```\n\nWhat we do now is to group the frogs by date. \n\n```{r}\n#| label: ch2-18\noregonfrogs%>%\n  mutate(SurveyDate=as.Date(SurveyDate,\"%m/%d/%Y\"))%>%\n  arrange(SurveyDate)%>%\n  count(SurveyDate,Ordinal)%>%\n  head(3)\n```\n\n\n## Work with Models\n\nPackages functionality from rgeos,raster,rgdal,terra packages are included in {sf},and {dismo} so we don't need to load them.\n\n```{r}\n#| label: ch2-19\n#| message: FALSE\n#| warning: FALSE\n#| paged.print: FALSE\n\n\nlibrary(dismo)  # for modeling\n```\n\n\nHere we use **wrld_simpl** data from {maptools}, to be able to use the `plot()` function faster, you can install the package or load it because data is included in the `/data` folder as `.RData` format. We can load the `data/case_study_1.RData` to load all the data we need for this workshop, this is already been done at the very beginning of this chapter. In case you'd like to do that separately, just type: `load(\"data/case_study_1.RData\")` and all data will be loaded in the global environment\n      \n      \n```{r}\n#| label: ch2-20\n#| eval: FALSE\nworld <- map_data(\"world\")\ngbi_coords<- tibble(x=do_gbif2$longitude,y=do_gbif2$latitude)\n\nggplot(world)+\n  geom_polygon(aes(long,lat,group=group),fill=\"grey90\",color=\"grey30\") +\n  geom_polygon(data=states, aes(long,lat,group=group),color=\"grey40\") +\n  geom_point(data = gbi_coords, aes(x,y),\n             color=\"pink\") +\n  coord_sf(xlim=c(-125,-90),ylim=c(35,65))+\n  ggthemes::theme_map()\n```\n\nThis is a raster stack composed of 19 raster layers.\n\n```{r}\n#| label: ch2-21\n#| cache: TRUE\n#| eval: FALSE\n#| include: TRUE\nfrogs <-data.frame(long=do_gbif2$longitude,lat=do_gbif2$latitude)\nclimate <- dismo::getData(\"worldclim\",download = T,var=\"bio\",res=2.5)\n\nplot(climate,legend=FALSE)\n```\n\n```{r}\n#| label: ch2-22\n#| echo: FALSE\n#| eval: TRUE\nknitr::include_graphics(\"images/climate_plot.png\")\n```\n\n\n\n```{r}\n#| label: ch2-23\n#| eval: FALSE\n#| include: TRUE\nfrog_climate <- extract(climate,frogs)\n```\n\n\n```{r}\n#| label: ch2-24\nfrog_climate %>% head(3)\n```\n\nApply the **Bioclim algorithm** used for species distribution modeling, the classic **climate-envelope-model**. It computes the similarity of a location by comparing the values of environmental variables at any location to a percentile distribution of the values at known locations of occurrence. More info here: `?dismo::bioclim`\n\nWe use the `pairs(x, v=NULL, pa='pa', hist=TRUE, cor=TRUE)` function to plot the results of the model, with options from the {dismo} package.\n\n```{r}\n#| label: ch2-25\n#| eval: FALSE\nrequire(dismo)\nbioclim.mod <- dismo::bioclim(frog_climate)\n```\n\n\n```{r}\n#| label: ch2-26\n#| eval: FALSE\n#| include: TRUE\npairs(bioclim.mod,pa=\"pa\")\n```\n\n```{r}\n#| label: ch2-27\n#| echo: FALSE\n#| eval: TRUE\nknitr::include_graphics(\"images/pairs_bioclim.png\")\n```\n\n\nNow, let's build a stack with the `stack()` function, including all the bioclimatic layers from the original raster stack. \n\n```{r}\n#| label: ch2-28\n#| eval: FALSE\n#| include: TRUE\n\n\ndoParallel::registerDoParallel()\npredictors <- stack(climate$bio1,climate$bio2,climate$bio3,\n                    climate$bio4,climate$bio5,\n                    climate$bio6,climate$bio7,climate$bio8,\n                    climate$bio9,climate$bio10,climate$bio11,\n                    climate$bio12,climate$bio13,climate$bio14,\n                    climate$bio15,climate$bio16,climate$bio17,\n                    climate$bio18,climate$bio19)\npredictions <- predict(predictors,bioclim.mod)\n```\n\n```{r}\n#| label: ch2-29\n#| eval: TRUE\n#| include: FALSE\npredictions\n```\n\n\n```{r}\n#| label: ch2-30\n#| eval: FALSE\n#| include: TRUE\nplot(predictions,xlim=c(-125,-100),ylim=c(35,55),axes=T)\n```\n\n\n```{r}\n#| label: ch2-31\n#| echo: FALSE\nknitr::include_graphics(\"images/frogs_location_raster.png\")\n```\n\n\n\n```{r}\n#| label: ch2-32\n#| eval: FALSE\n#| echo: FALSE\nsave.image(\"data/case_study_1.RData\")\n```\n\n---\n\n\n\n\n\n\n\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"case_study_1.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.1.189","bibliography":["references.bib"],"editor":"visual","theme":"cosmo"},"extensions":{"book":{"multiFile":true}}},"pdf":{"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","output-file":"case_study_1.pdf"},"language":{},"metadata":{"block-headings":true,"bibliography":["references.bib"],"editor":"visual","documentclass":"scrreprt"},"extensions":{"book":{}}}}}